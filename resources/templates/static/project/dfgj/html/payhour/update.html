<!DOCTYPE html>
<html ng-app="add">
<head>
<title>学校-修改</title>

<meta http-equiv="keywords" content="keyword1,keyword2,keyword3">
<meta http-equiv="description" content="this is my page">
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<link rel="icon" type="image/x-icon" href="../../../resource/img/logo.ico">
<link rel="stylesheet" type="text/css" href="../../../../resource/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="../../../../resource/css/common.css">
<script type="text/javascript" src="../../../../resource/js/angular-1.0.1.min.js"></script>
<script type="text/javascript" src="../../../../resource/js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="../../../../resource/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../../../../resource/js/jquery.cookie.js"></script>
<script src="../../../../resource/js/date/js/eap.core.js"></script>
<!-- 表单验证 -->
<link rel="stylesheet" type="text/css" href="../../../../resource/js/validate/css/validate.css" />
<script type="text/javascript" src="../../../../resource/js/validate/js/eap.tip.js"></script>
<script type="text/javascript" src="../../../../resource/js/validate/js/eap.validate.js"></script>
<script type="text/javascript" src="../../../../resource/js/date/js/eap.lang-zh_CN.js"></script>
<script type="text/javascript" src="../../../../resource/js/response.js"></script>
<!-- 弹出框 -->
<script src="../../../../resource/js/date/js/eap.util.date.js"></script>
<script src="../../../../resource/js/util.js"></script>
<style type="text/css">
#dateOption>label {
	font: 14px;
	font-weight: normal;
	border: 0px;
}

h4>label {
	margin: 4px 10px;
	width: 40px;
	padding: 2px;
	text-align: center;
	border: solid 1px #ccc;
	border-radius: 2px;
}

.tableHeadr {
	height: 35px;
	line-height: 35px;
	background: #2A94DB;
	font-size: :18px;
	font-weight: bold;
	color: #fff;
}

.tableOption {
	background: #E5E3D8;
	font-size: :18px;
	font-weight: bold;
}

td {
	text-align: center;
	width: 90px;
	border: solid 1px #ccc;
	padding: 0px 2px;
}

td>span {
	color: #ccc;
}

input[type='checkbox'] {
	margin: 6px 0px;
	background: #E5E3D8
}

.button {
	margin: 10px 10px 0px 200px;
	width: 70px;
	height: 30px;
	background: #2A94DB;
	color: #fff;
}

.checkOption {
	background: #FA7E7E
}
.checkOption2 {
	background: #68b3ff
}
</style>
<script type="text/javascript">
	var paramdata = {};
	var payhour = {};
	var add = angular.module("add", []);
	add.controller("addController", function($scope, $http) {
		$scope.formData = {};
		$scope.initdata = function() {
			$http({
				url : parent.getFunctionLinksHref("self"),
				method : 'GET',
				dataType : "json",
				withCredentials : true,
				headers : {
					'Content-Type' : 'application/json;charset=UTF-8;'
				},
				data : ''
			}).success(function(data, status, headers, config) {
				//响应成功
				payhour = data;
				$scope.initdatalist();
			}).error(function(data, status, headers, config) {
				//处理响应失败
				response(status);
			});
		}

		$scope.initdatalist = function() {
			$http({
				url : parent.getFunctionLinksHref("hourlist"),
				method : 'POST',
				dataType : "json",
				withCredentials : true,
				headers : {
					'Content-Type' : 'application/json;charset=UTF-8;',
					"orderby" : "datetime",
					"dir" : "asc"
				},
				data : JSON.stringify({
					typecode : 700
				})
			}).success(function(data, status, headers, config) {
				$scope.formDatalist = data;
				$scope.initdatetime();
			}).error(function(data, status, headers, config) {
				//处理响应失败
				response(status);
			})
		}

		$scope.initdatetime = function() {
			$http({
				url : parent.getMenuLinksHref("admindictionaryself"),
				method : 'POST',
				dataType : "json",
				withCredentials : true,
				headers : {
					'Content-Type' : 'application/json;charset=UTF-8;'
				},
				data : JSON.stringify({
					typecode : 700
				})
			}).success(function(data, status, headers, config) {
				paramdata.option = data;
				init($scope.formDatalist);
			}).error(function(data, status, headers, config) {
				//处理响应失败
				response(status);
			})
		}

		//返回
		$scope.onReturn = function() {
			history.go(-1);
		}
		$scope.initdata();
	})
</script>
</head>

<body ng-controller="addController">
	<form method="post" id="saveForm" action="">
		<!-- 操作按钮操作区 -->
		<div class="col-lg-12 topActionPanel">
			<div>
				<button type="button" class="btn btn-primary" ng-click="onReturn()">返
					回</button>
			</div>
		</div>
		<div class="col-lg-6">
			<div id="datepanel">
				<div id="dateList"></div>
			</div>
		</div>
	</form>
</body>
<script type="text/javascript">
	var aryDay = new Array("日", "一", "二", "三", "四", "五", "六");
	var incount = 1;//和具体数量个数一致
	function init(datalist) {
		initElement(datalist);
		$(document).on("click","input[type='checkbox']",
			function() {
				var checkedstatus = $(this).attr("checked") != undefined ? $(this).removeAttr("checked") : $(this).attr("checked", true);
				var data = JSON.parse($(this).attr("data"));
				var hour = data.hour;
				var links = data.links==null?data._links:data.links;
				parent.setFunctionLinksHref(links);
				if ($(checkedstatus).attr("checked")) {
					hour.status = 771;
					$(this).parent().addClass("checkOption2");
				} else {
					hour.status = 772;
					$(this).parent().removeClass("checkOption2");
				}
				$.ajax({
					type : "PUT",
					url : parent.getFunctionLinksHref("self"),
					data: JSON.stringify(hour),
					async : false,
					withCredentials: true,
					dataType : 'json',
					headers : {'Content-Type' : 'application/json;charset=UTF-8;'},
					success : function(data) {
					},
					error : function(XMLHttpRequest, textStatus,errorThrown) {
						response(XMLHttpRequest.status);
					}
				});
		})
	}
	
	var aryDay = new Array("日", "一", "二", "三", "四", "五", "六");
	var datelen = 7;//一周七天
	/* 初始化数据 */
	function initElement(datalist) {
		$("#datepanel").show();
		var dateAll = [];
		var dateAll2 = [];
		$("#dateList").html("");
		var option = paramdata.option;//默认初始化数据
		var optionlen = option.length;//数据（选项）行数
		var lastday = getCurrentMonth(payhour.sdatetime);
		var startTimes = new Date(Date.parse(payhour.sdatetime.replace(/-/g,   "/"))).getTime();     
	    var endTimes = new Date(Date.parse(payhour.edatetime.replace(/-/g,   "/"))).getTime(); 
	    var datelen = 7;//一周七天
	    var dcount = (Math.abs((startTimes  - endTimes))/(1000*60*60*24)); //一共多少天
	    var dates = dcount%datelen==0?dcount/datelen:(dcount/datelen)+1;
		var dd = dcount;//具体多少天
		if (payhour.sdatetime != undefined) {
			var sdate = lastday[0].formatDate("yyyy-MM-dd");
			var startDay = compareDate(payhour.sdatetime, sdate, "-");//第几天开始计算
			var moreDates = startDay % datelen != 0 ? parseInt(startDay
					/ datelen) + 1 : startDay / datelen;
			dd = dd + moreDates * datelen;
			dates = dates + moreDates;
		}
		var tr_row =  dates;
		if (isNaN(tr_row))
			return;
		var table = $("<table></table>");
		var tr0 = $("<tr class='tableHeadr'></tr>");//每行
		var td = $("<td></td>");
		tr0.append(td);
		for (var i = 0; i < aryDay.length; i++) {
			var td = $("<td>" + aryDay[i] + "</td>");
			tr0.append(td);
			table.append(tr0);

		}
		var firstDay = lastday[0].DateAdd("d", 0).getDay();//每月第一个天周几
		var weeklength = aryDay.length - firstDay;
		for (var r = 0; r <= tr_row; r++) {
			var tr = $("<tr></tr>");//每行
			var td = $("<td></td>");
			if (r == 0) {
				var td = $("<td>日期</td>");
			}
			tr.append(td);
			table.append(tr);
			if (r == 0) {//第一行的单元格单独处理
				for (var j = 0; j < firstDay; j++) {
					var td = $("<td></td>");
					tr.append(td);
				}
			}
			var startNo = datelen * r != 0 ? weeklength + datelen * (r - 1) : 0;//从什么位置开始
			var endNo = datelen * r != 0 ? weeklength + datelen * r
					: weeklength;//到什么位置结束
			endNo = r == tr_row ? dd : endNo;//最后一行的时候从当月最后一天结束
			for (var i = startNo; i < endNo; i++) {
				for (var d = 0; d < aryDay.length; d++) {
					currdw = aryDay[lastday[0].DateAdd("d", i).getDay()];
					if (aryDay[d] == currdw) {
						currTd = lastday[0].DateAdd("d", i).formatDate(
								"yyyy-MM-dd");
						td = $("<td>" + currTd + "<br/> <span>星期" + currdw
								+ "</span></td>");
						tr.append(td);
						dateAll[dateAll.length] = currTd;
						dateAll2[dateAll2.length] = currdw;
					}
				}
			}

			/* 日期、当天及之后的七天不同的时间段checkbox */
			for (var row = 0; row < optionlen; row++) {
				var tr1 = $("<tr class='tableOption'></tr>");
				var td = $("<td>" + option[row].dictionary.name + "</td>");
				tr1.append(td);
				if (r == 0) {//第一行的单元格单独处理
					for (var j = 0; j < firstDay; j++) {
						var td = $("<td></td>");
						tr1.append(td);
					}
				}
				for (var i = startNo; i < endNo; i++) {
					currTd = lastday[0].DateAdd("d", i)
							.formatDate("yyyy-MM-dd");
					currdw = aryDay[lastday[0].DateAdd("d", i).getDay()];//周几
					var value = currTd + "|" + paramdata.option[row].dictionary.code;
					var id = currTd + paramdata.option[row].dictionary.code;
					var td = $("<td id=\""+id+"\"></td>");
					var input_check = $("<input type='checkbox' name='date' value='"+value+"' disabled='ture' datas=''></input>");
					td.append(input_check);
					tr1.append(td);
				}
				table.append(tr1);
			}
		}
		$("#dateList").append(table);
		var totalhour = $("#totalhour").val();//获取总课时
		var starttime = $("#defaultdate").val();
		var checkOption = $("input[name='option']:checked");
		var len = dateAll.length;
		for (var i = 0; i < datalist.length; i++) {
			var input = $("#" + datalist[i].hour.datetime + datalist[i].hour.time).children();
			$(input[0]).attr("data", JSON.stringify(datalist[i]));
			if(datalist[i].hour.status==771){
				$(input[0]).attr("checked", "true");
				$(input[0]).removeAttr("disabled");
				$("#" + datalist[i].hour.datetime + datalist[i].hour.time).addClass("checkOption2");
			}else{
				$("#" + datalist[i].hour.datetime + datalist[i].hour.time).addClass("checkOption");
				$(input[0]).removeAttr("disabled");
			}
		}

	}

	//+---------------------------------------------------
	//| 日期计算
	//+---------------------------------------------------
	Date.prototype.DateAdd = function(strInterval, Number) {
		var dtTmp = this;
		switch (strInterval) {
		case 's':
			return new Date(Date.parse(dtTmp) + (1000 * Number));
		case 'n':
			return new Date(Date.parse(dtTmp) + (60000 * Number));
		case 'h':
			return new Date(Date.parse(dtTmp) + (3600000 * Number));
		case 'd':
			return new Date(Date.parse(dtTmp) + (86400000 * Number));
		case 'w':
			return new Date(Date.parse(dtTmp) + ((86400000 * 7) * Number));
		case 'q':
			return new Date(dtTmp.getFullYear(), (dtTmp.getMonth()) + Number
					* 3, dtTmp.getDate(), dtTmp.getHours(), dtTmp.getMinutes(),
					dtTmp.getSeconds());
		case 'm':
			return new Date(dtTmp.getFullYear(), (dtTmp.getMonth()) + Number,
					dtTmp.getDate(), dtTmp.getHours(), dtTmp.getMinutes(),
					dtTmp.getSeconds());
		case 'y':
			return new Date((dtTmp.getFullYear() + Number), dtTmp.getMonth(),
					dtTmp.getDate(), dtTmp.getHours(), dtTmp.getMinutes(),
					dtTmp.getSeconds());
		}
	}
	/***  
	 * 获得本月的起止时间  
	 */
	function getCurrentMonth(date1) {
		//起止日期数组    
		var startStop = new Array();
		//获取当前时间    
		var currentDate = new Date(date1);
		//获得当前月份0-11    
		var currentMonth = currentDate.getMonth();
		//获得当前年份4位年    
		var currentYear = currentDate.getFullYear();
		//求出本月第一天    
		var firstDay = new Date(currentYear, currentMonth, 1);
		//当为12月的时候年份需要加1    
		//月份需要更新为0 也就是下一年的第一个月    
		if (currentMonth == 11) {
			currentYear++;
			currentMonth = 0; //就为    
		} else {
			//否则只是月份增加,以便求的下一月的第一天    
			currentMonth++;
		}
		//一天的毫秒数    
		var millisecond = 1000 * 60 * 60 * 24;
		//下月的第一天    
		var nextMonthDayOne = new Date(currentYear, currentMonth, 1);
		//求出上月的最后一天    
		var lastDay = new Date(nextMonthDayOne.getTime() - millisecond);

		//添加至数组中返回    
		startStop.push(firstDay);
		startStop.push(lastDay);
		//返回    
		return startStop;
	};
	/* 两个日期相隔多少天 */
	function compareDate(first, second, sign) {
		fArray = first.split(sign);
		sArray = second.split(sign);
		var fDate = new Date(fArray[0], fArray[1], fArray[2]);
		var sDate = new Date(sArray[0], sArray[1], sArray[2]);

		var t = Math.abs(fDate.getTime() - sDate.getTime());
		var days = t / (1000 * 60 * 60 * 24);
		return days;
	}
</script>
</html>
